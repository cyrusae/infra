---
# roles/babbage_quirks/tasks/main.yml
# Applied ONLY to babbage in site.yml. Not a role for desktops in general.
#
# Babbage has a hardware L3 cache defect on CPU core #3.
# Mitigation: isolate cores 3 and 7 (the defective core and its HT sibling)
# from the kernel scheduler via the isolcpus kernel parameter.
# This leaves 6 cores / 12 threads available. Stable since Feb 12, 2026.
#
# See: KB - Babbage Mystery Reboots for full investigation history.
# Remove this role if the CPU is ever replaced.

- name: Set isolcpus kernel parameter in GRUB
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="isolcpus={{ isolcpus }}"'
    backrefs: true
  become: true
  notify: Update GRUB

- name: Verify isolcpus will be set correctly
  ansible.builtin.command: grep GRUB_CMDLINE_LINUX_DEFAULT /etc/default/grub
  register: grub_check
  changed_when: false

- name: Show GRUB cmdline for confirmation
  ansible.builtin.debug:
    msg: "Babbage GRUB cmdline: {{ grub_check.stdout }}"
