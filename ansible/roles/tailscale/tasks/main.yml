---
# roles/tailscale/tasks/main.yml
# Installs Tailscale and brings the node up with subnet route advertisement.
# Babbage additionally advertises as an exit node (tailscale_exit_node: true in host_vars).
#
# IMPORTANT -- manual step required after first run:
#   Route advertisement and exit node capability must be approved in the
#   Tailscale admin console at https://login.tailscale.com/admin/machines
#   Ansible cannot do this -- it's a Tailscale-side authorization.
#   For each node: Machines -> ... -> Edit route settings -> approve subnet + exit node.

# FIX: command-instead-of-module + risky-shell-pipe
# Previously: ansible.builtin.shell with curl | tee (pipe without pipefail,
# and curl is the wrong tool when get_url exists).
# Now: ansible.builtin.get_url handles the download idempotently. The `creates:`
# guard we had in the shell task is replaced by get_url's built-in behaviour --
# it won't re-download if the destination file already exists and force: false (default).
- name: Download Tailscale apt signing key
  ansible.builtin.get_url:
    url: https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg
    dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
    mode: "0644"
  become: true

- name: Add Tailscale apt repository
  ansible.builtin.copy:
    content: |
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main
    dest: /etc/apt/sources.list.d/tailscale.list
    mode: "0644"
  become: true
  notify: Update apt cache

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  become: true

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Check if already connected to tailnet
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  become: true

- name: Parse tailscale connection status
  ansible.builtin.set_fact:
    tailscale_connected: "{{ (tailscale_status.stdout | from_json).BackendState == 'Running' }}"
  when: tailscale_status.stdout | length > 0

# Build the tailscale up flags dynamically based on host role.
# All nodes: advertise subnet routes.
# Babbage only: also advertise as exit node.

# FIX: no-changed-when
# Previously: ansible.builtin.command with no changed_when, so Ansible always
# reported "changed" even on repeat runs where nothing actually changed.
# The right answer here is changed_when: true -- this task genuinely does change
# state (connects to the tailnet) but ONLY runs when tailscale_connected is false,
# so it accurately represents "yes, I changed something" on the runs it executes.
# It will never run on subsequent plays once the node is connected.
- name: Bring up Tailscale (with exit node)
  ansible.builtin.command: >
    tailscale up
    --authkey={{ tailscale_authkey }}
    --advertise-routes={{ tailscale_subnet }}
    --advertise-exit-node
    --accept-dns=false
  become: true
  changed_when: true
  when:
    - not ansible_check_mode
    - not tailscale_connected
    - tailscale_exit_node | default(false)
  # --accept-dns=false: we run our own Pi-hole; don't let Tailscale override DNS

- name: Bring up Tailscale (subnet routes only)
  ansible.builtin.command: >
    tailscale up
    --authkey={{ tailscale_authkey }}
    --advertise-routes={{ tailscale_subnet }}
    --accept-dns=false
  become: true
  changed_when: true
  when:
    - not ansible_check_mode
    - not tailscale_connected
    - not (tailscale_exit_node | default(false))
