---
# roles/k3s_secondary/tasks/main.yml
# Joins Epimetheus and Kabandha to the cluster as additional control plane nodes.
# Runs AFTER k3s_primary play has completed and the primary is Ready.
#
# The join token is read from hostvars[k3s_primary_host] where it was set
# as a fact during the primary play.

- name: Create K3s config directory
  ansible.builtin.file:
    path: /etc/rancher/k3s
    state: directory
    mode: "0755"
  become: true

- name: Write K3s config file
  ansible.builtin.template:
    src: k3s-config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    mode: "0644"
  become: true
  vars:
    k3s_token: "{{ hostvars[k3s_primary_host]['k3s_token'] }}"

- name: Check if K3s is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Install K3s (secondary control plane)
  ansible.builtin.shell:
    cmd: curl -sfL https://get.k3s.io | sh -s - server
  become: true
  when: not k3s_binary.stat.exists
  changed_when: true
  # No --cluster-init here -- that's only for the primary.
  # server, token, node-ip all come from config.yaml.

- name: Wait for this node to reach Ready state
  ansible.builtin.command: >
    k3s kubectl get node {{ inventory_hostname }}
    -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  become: true
  register: node_ready_status
  until: node_ready_status.stdout == "True"
  retries: 30
  delay: 10
  changed_when: false

- name: Verify K3s config was applied (check for kebab-case warnings)
  ansible.builtin.command: journalctl -u k3s --no-pager -n 50
  become: true
  register: k3s_journal
  changed_when: false

- name: Warn if config syntax issues detected
  ansible.builtin.debug:
    msg: >
      WARNING: K3s log contains 'Unknown flag' -- config.yaml key syntax may be wrong.
      Check /etc/rancher/k3s/config.yaml uses kebab-case keys.
      See KB - TLS and Certificates.
  when: "'Unknown flag' in k3s_journal.stdout"

- name: Install etcdctl (control plane nodes need it for recovery)
  ansible.builtin.shell:
    cmd: |
      cd /tmp
      curl -L https://github.com/etcd-io/etcd/releases/download/v3.6.6/etcd-v3.6.6-linux-amd64.tar.gz \
        -o etcd-v3.6.6-linux-amd64.tar.gz
      tar xzf etcd-v3.6.6-linux-amd64.tar.gz
      cp etcd-v3.6.6-linux-amd64/etcdctl /usr/local/bin/
      chmod +x /usr/local/bin/etcdctl
      rm -rf etcd-v3.6.6-linux-amd64*
    creates: /usr/local/bin/etcdctl
  become: true
