---
# roles/tailscale/tasks/main.yml
# Installs Tailscale and brings the node up with subnet route advertisement.
# Babbage additionally advertises as an exit node (tailscale_exit_node: true in host_vars).
#
# IMPORTANT -- manual step required after first run:
#   Route advertisement and exit node capability must be approved in the
#   Tailscale admin console at https://login.tailscale.com/admin/machines
#   Ansible cannot do this -- it's a Tailscale-side authorization.
#   For each node: Machines -> ... -> Edit route settings -> approve subnet + exit node.

- name: Add Tailscale apt signing key
  ansible.builtin.shell:
    cmd: |
      curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg \
        | tee /usr/share/keyrings/tailscale-archive-keyring.gpg > /dev/null
    creates: /usr/share/keyrings/tailscale-archive-keyring.gpg
  become: true

- name: Add Tailscale apt repository
  ansible.builtin.copy:
    content: |
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main
    dest: /etc/apt/sources.list.d/tailscale.list
    mode: "0644"
  become: true
  notify: Update apt cache

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  become: true

- name: Enable and start tailscaled
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started
  become: true

- name: Check if already connected to tailnet
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  become: true

- name: Parse tailscale connection status
  ansible.builtin.set_fact:
    tailscale_connected: "{{ (tailscale_status.stdout | from_json).BackendState == 'Running' }}"

# Build the tailscale up flags dynamically based on host role.
# All nodes: advertise subnet routes.
# Babbage only: also advertise as exit node.
- name: Bring up Tailscale (with exit node)
  ansible.builtin.command: >
    tailscale up
    --authkey={{ tailscale_authkey }}
    --advertise-routes={{ tailscale_subnet }}
    --advertise-exit-node
    --accept-dns=false
  become: true
  when:
    - not tailscale_connected
    - tailscale_exit_node | default(false)
  # --accept-dns=false: we run our own Pi-hole; don't let Tailscale override DNS

- name: Bring up Tailscale (subnet routes only)
  ansible.builtin.command: >
    tailscale up
    --authkey={{ tailscale_authkey }}
    --advertise-routes={{ tailscale_subnet }}
    --accept-dns=false
  become: true
  when:
    - not tailscale_connected
    - not (tailscale_exit_node | default(false))